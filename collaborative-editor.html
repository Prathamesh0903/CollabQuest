<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Collaborative Code Editor</title>
    
    <!-- Socket.IO Client -->
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    
    <!-- Monaco Editor -->
    <script src="https://cdn.jsdelivr.net/npm/monaco-editor@0.44.0/min/vs/loader.js"></script>
    
    <!-- RequireJS for Monaco -->
    <script>
        require = { paths: { vs: 'https://cdn.jsdelivr.net/npm/monaco-editor@0.44.0/min/vs' } };
    </script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #1e1e1e;
            color: #ffffff;
            height: 100vh;
            overflow: hidden;
        }
        
        .editor-container {
            display: flex;
            height: 100vh;
        }
        
        .sidebar {
            width: 300px;
            background: #252526;
            border-right: 1px solid #3c3c3c;
            display: flex;
            flex-direction: column;
        }
        
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        
        .toolbar {
            height: 50px;
            background: #2d2d30;
            border-bottom: 1px solid #3c3c3c;
            display: flex;
            align-items: center;
            padding: 0 20px;
            gap: 10px;
        }
        
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.2s;
        }
        
        .btn-primary {
            background: #007acc;
            color: white;
        }
        
        .btn-primary:hover {
            background: #005a9e;
        }
        
        .btn-secondary {
            background: #3c3c3c;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #4c4c4c;
        }
        
        .btn-danger {
            background: #d73a49;
            color: white;
        }
        
        .btn-danger:hover {
            background: #b31d28;
        }
        
        .editor-wrapper {
            flex: 1;
            position: relative;
        }
        
        #editor-container {
            width: 100%;
            height: 100%;
        }
        
        .file-tabs {
            height: 40px;
            background: #2d2d30;
            border-bottom: 1px solid #3c3c3c;
            display: flex;
            align-items: center;
            padding: 0 10px;
            gap: 5px;
            overflow-x: auto;
        }
        
        .file-tab {
            padding: 8px 16px;
            background: #3c3c3c;
            border-radius: 4px 4px 0 0;
            cursor: pointer;
            font-size: 13px;
            white-space: nowrap;
            transition: background-color 0.2s;
        }
        
        .file-tab:hover {
            background: #4c4c4c;
        }
        
        .file-tab.active {
            background: #1e1e1e;
            border-bottom: 2px solid #007acc;
        }
        
        .status-bar {
            height: 30px;
            background: #007acc;
            color: white;
            display: flex;
            align-items: center;
            padding: 0 20px;
            font-size: 12px;
        }
        
        .connection-status {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
        }
        
        .connection-status.success {
            background: #28a745;
            color: white;
        }
        
        .connection-status.error {
            background: #dc3545;
            color: white;
        }
        
        .connection-status.warning {
            background: #ffc107;
            color: black;
        }
        
        .sidebar-section {
            padding: 20px;
            border-bottom: 1px solid #3c3c3c;
        }
        
        .sidebar-section h3 {
            margin-bottom: 15px;
            font-size: 16px;
            color: #cccccc;
        }
        
        .collaborators-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .collaborator {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            background: #3c3c3c;
            border-radius: 6px;
        }
        
        .collaborator-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
            font-size: 14px;
        }
        
        .collaborator-details {
            flex: 1;
        }
        
        .collaborator-name {
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 2px;
        }
        
        .collaborator-status {
            font-size: 12px;
            color: #cccccc;
        }
        
        .session-info {
            background: #2d2d30;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 15px;
        }
        
        .session-name {
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .session-details {
            font-size: 12px;
            color: #cccccc;
        }
        
        .actions {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 6px;
            color: white;
            font-weight: 500;
            z-index: 1000;
            animation: slideIn 0.3s ease-out;
        }
        
        .notification.success {
            background: #28a745;
        }
        
        .notification.error {
            background: #dc3545;
        }
        
        .notification.warning {
            background: #ffc107;
            color: black;
        }
        
        .notification.info {
            background: #17a2b8;
        }
        
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        .typing-indicator {
            position: absolute;
            bottom: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 12px;
            z-index: 100;
        }
        
        .console-panel {
            height: 200px;
            background: #1e1e1e;
            border-top: 1px solid #3c3c3c;
            display: none;
        }
        
        .console-header {
            height: 30px;
            background: #2d2d30;
            border-bottom: 1px solid #3c3c3c;
            display: flex;
            align-items: center;
            padding: 0 15px;
            font-size: 12px;
            font-weight: bold;
        }
        
        .console-content {
            padding: 15px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            overflow-y: auto;
            height: calc(100% - 30px);
        }
        
        .console-output {
            color: #cccccc;
            margin-bottom: 5px;
        }
        
        .console-error {
            color: #f97583;
        }
        
        .console-success {
            color: #7ee787;
        }
        
        /* Remote cursor and selection styles */
        .remote-cursor {
            background-color: rgba(255, 107, 107, 0.3);
            border-left: 2px solid #ff6b6b;
        }
        
        .remote-selection {
            background-color: rgba(78, 205, 196, 0.2);
        }
        
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100vh;
            font-size: 18px;
            color: #cccccc;
        }
        
        .spinner {
            width: 20px;
            height: 20px;
            border: 2px solid #3c3c3c;
            border-top: 2px solid #007acc;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <!-- Loading Screen -->
    <div id="loading" class="loading">
        <div class="spinner"></div>
        Connecting to collaborative session...
    </div>
    
    <!-- Main Editor Interface -->
    <div id="editor-interface" class="editor-container" style="display: none;">
        <!-- Sidebar -->
        <div class="sidebar">
            <!-- Session Info -->
            <div class="sidebar-section">
                <div class="session-info">
                    <div class="session-name" id="session-name">Loading session...</div>
                    <div class="session-details" id="session-details">
                        <div>Status: <span id="connection-status" class="connection-status">Connecting...</span></div>
                        <div>Files: <span id="file-count">0</span></div>
                        <div>Collaborators: <span id="collaborator-count">0</span></div>
                    </div>
                </div>
            </div>
            
            <!-- Collaborators -->
            <div class="sidebar-section">
                <h3>Collaborators (<span id="collaborator-count-header">0</span>)</h3>
                <div id="collaborators-list" class="collaborators-list">
                    <!-- Collaborators will be populated here -->
                </div>
            </div>
            
            <!-- Actions -->
            <div class="sidebar-section">
                <h3>Actions</h3>
                <div class="actions">
                    <button class="btn btn-primary" onclick="collaborativeEditor.executeCode()">
                        ▶️ Run Code
                    </button>
                    <button class="btn btn-secondary" onclick="collaborativeEditor.forceSaveSession()">
                        💾 Save Session
                    </button>
                    <button class="btn btn-secondary" onclick="collaborativeEditor.getSessionStats()">
                        📊 Session Stats
                    </button>
                    <button class="btn btn-secondary" onclick="collaborativeEditor.recoverSessionState()">
                        🔄 Recover State
                    </button>
                    <button class="btn btn-secondary" onclick="collaborativeEditor.createNewFile()">
                        📄 New File
                    </button>
                    <button class="btn btn-danger" onclick="collaborativeEditor.deleteCurrentFile()">
                        🗑️ Delete File
                    </button>
                    <button class="btn btn-danger" onclick="collaborativeEditor.leaveSession()">
                        🚪 Leave Session
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Main Content -->
        <div class="main-content">
            <!-- Toolbar -->
            <div class="toolbar">
                <button class="btn btn-primary" onclick="collaborativeEditor.executeCode()">
                    ▶️ Run
                </button>
                <button class="btn btn-secondary" onclick="collaborativeEditor.forceSaveSession()">
                    💾 Save
                </button>
                <button class="btn btn-secondary" onclick="toggleConsole()">
                    📟 Console
                </button>
                <div style="flex: 1;"></div>
                <span id="status-bar" class="status-bar">Ready</span>
            </div>
            
            <!-- File Tabs -->
            <div id="file-tabs" class="file-tabs">
                <!-- File tabs will be populated here -->
            </div>
            
            <!-- Editor -->
            <div class="editor-wrapper">
                <div id="editor-container"></div>
                
                <!-- Typing Indicator -->
                <div id="typing-indicator" class="typing-indicator" style="display: none;">
                    <span id="typing-user"></span> is typing...
                </div>
            </div>
            
            <!-- Console Panel -->
            <div id="console-panel" class="console-panel">
                <div class="console-header">
                    Console Output
                </div>
                <div id="console-content" class="console-content">
                    <!-- Console output will appear here -->
                </div>
            </div>
        </div>
    </div>
    
    <!-- Notification Container -->
    <div id="notification-container"></div>
    
    <!-- Include the collaborative editor script -->
    <script src="client-example.js"></script>
    
    <script>
        // Enhanced notification system
        function showNotification(message, type = 'info', duration = 5000) {
            const container = document.getElementById('notification-container');
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            
            container.appendChild(notification);
            
            // Auto-remove after duration
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, duration);
        }
        
        // Enhanced typing indicator
        function showTypingIndicator(userName, color) {
            const indicator = document.getElementById('typing-indicator');
            const userSpan = document.getElementById('typing-user');
            
            userSpan.textContent = userName;
            userSpan.style.color = color;
            indicator.style.display = 'block';
            
            // Hide after 3 seconds
            setTimeout(() => {
                indicator.style.display = 'none';
            }, 3000);
        }
        
        // Console panel toggle
        function toggleConsole() {
            const consolePanel = document.getElementById('console-panel');
            const isVisible = consolePanel.style.display !== 'none';
            
            if (isVisible) {
                consolePanel.style.display = 'none';
            } else {
                consolePanel.style.display = 'block';
            }
        }
        
        // Enhanced execution result display
        function displayExecutionResult(result) {
            const consoleContent = document.getElementById('console-content');
            const outputDiv = document.createElement('div');
            
            if (result.success) {
                outputDiv.className = 'console-output console-success';
                outputDiv.innerHTML = `
                    <strong>✅ Execution completed by ${result.displayName}</strong><br>
                    <pre>${result.result}</pre>
                `;
            } else {
                outputDiv.className = 'console-output console-error';
                outputDiv.innerHTML = `
                    <strong>❌ Execution failed by ${result.displayName}</strong><br>
                    <pre>${result.error}</pre>
                `;
            }
            
            consoleContent.appendChild(outputDiv);
            consoleContent.scrollTop = consoleContent.scrollHeight;
        }
        
        // Override the notification function in the main script
        window.showNotification = showNotification;
        window.showTypingIndicator = showTypingIndicator;
        window.displayExecutionResult = displayExecutionResult;
        
        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', () => {
            // Hide loading screen and show editor interface
            setTimeout(() => {
                document.getElementById('loading').style.display = 'none';
                document.getElementById('editor-interface').style.display = 'flex';
            }, 1000);
        });
        
        // Example usage with URL parameters:
        // http://localhost:3000/collaborative-editor.html?session=ABC12345
        
        // You can also test with different session IDs:
        // http://localhost:3000/collaborative-editor.html?session=TEST123
        
        // For access code protected sessions:
        // http://localhost:3000/collaborative-editor.html?session=PROTECTED123&accessCode=secret123
    </script>
</body>
</html>
